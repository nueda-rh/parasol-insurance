= パイプラインによる請求文書の処理
include::_attributes.adoc[]

== パイプラインが何か可能か？
Web アプリケーションの中で、まだ処理されていない請求がいくつかあることがわかります。 

[.bordershadow]
image::05/05-new-app-claim-unprocessed.jpg[]

この処理を実行したいのですが、完全に自動化できればさらに良いでしょう!

そのためには、信頼性チェックパイプラインのように、アドホックで実行することもスケジュールで実行することもできるパイプラインを使用します。ここで実行される内容は厳密にはデータサイエンスパイプラインではなく、どちらかというと、シンプルなCIパイプラインです。
// このパイプラインは、自動的にトリガーできる ArgoCD または Tekton パイプラインを作成するための良い出発点でもあります。

== パイプラインの内容

`parasol-insurance/lab-materials/05/05-05` に移動すると、さまざまなファイルが表示されます。+

[.bordershadow]
image::05/05-process-claims-yaml.jpg[]


今回は、**パイプライン** の **yaml 定義** である `process_claims.yaml` を使用して請求を処理します。+

パイプラインの主なファイルとその機能は次のとおりです:

* *get_claims* - データベースに接続し、未処理の請求を取得して、ファイル `claims.json` を通じて他のタスクに渡されるリストに追加します。
* 次のスクリプトは、処理する必要があるすべての請求を調べ、テキストの本文全体を使用して重要な機能を見つけ、結果をデータベースにプッシュします:
** *get_location* - 事故発生場所を検索
** *get_accident_time* - 事故発生時刻の検索
** *summarize_text* - 本文を短く要約する
** *get_sentiment* - テキストの感情を取得する
* *detect_objects* - 請求の画像をダウンロードし、提供された物体検出モデルを使用して画像内の損害を分類する。


== 新しい PVC を作成する

パイプラインを実行する前に、中間ファイルと結果を格納するために使用する PVC を作成する必要があります。 +

* {ocp-short} コンソールに移動します
* コンソールの左上で、**Developer** から **Administrator** にビューを変更してください
+
[.bordershadow]
image::05/05-switch-to-admin-view.jpg[]

* Administrator ビューで **Storage** から **PersistentVolumeClaims** を開いてください
+
[.bordershadow]
image::05/05-PVC.png[go to PVC]

* 正しいプロジェクト（ユーザー名）に入っていることを確認し、 **Create PersistentVolumeClaim** を押します。
+
[.bordershadow]
image::05/05-create-pvc-button.jpg[PVC を作成]

* 次の設定を使用します。
** StorageClass:
[.lines_space]
[.console-input]
[source, text]
[subs=attributes+]
ocs-storagecluster-cephfs
** PersistentVolumeClaim name:
[.lines_space]
[.console-input]
[source, text]
[subs=attributes+]
processing-pipeline-storage
** Access mode:
[.lines_space]
[.console-input]
[source, text]
[subs=attributes+]
Shared access (RWX)
** Size:
[.lines_space]
[.console-input]
[source, text]
[subs=attributes+]
1 GiB

* 次のようになります:
+
[.bordershadow]
image::05/05-PVC-settings.png[PVC settings]

* 次に **Create** を押します

== パイプラインをインポートする
パイプラインをインポートするには、まず `process_claims.yaml` ファイルをローカルにダウンロードします。
`parasol-insurance/lab-materials/05/05-05` に移動して、ファイルを見つけます。


// * これを行うには、VSCode環境の左上にあるメニューを選択し、*File -> Save As...*に移動します。
// [.bordershadow]
// image::05/05-download-process-yaml.png[download process claims yaml]
// 次に、データサイエンスプロジェクトに移動し、インポートパイプラインを押します。

* まず、 `process_claims.yaml` ファイルをラップトップにダウンロードします
** ワークベンチでファイルを右クリックし、 **Download** を選択します
** ファイルを自環境のどこかに保存します
* 次に、 {rhoai} ダッシュボードに移動します
* データサイエンスプロジェクトを選択します
* **Pipelines** セクションが表示されるまでスクロールダウンします
* **Import Pipeline** をクリックします
+

[.bordershadow]
image::05/05-import-pipeline.jpg[import pipeline]

* ここで `process_claims.yaml` ファイルをドラッグ＆ドロップするか、アップロードボタンを使用してアップロードします
* その後、パイプラインに `Process Claims Pipeline` のような適切な名前を付けてください
* その後は、以下のような表示になります。
+
[.bordershadow]
image::05/05-import-pipeline-highlighted.jpg[imported pipeline]

* **Import Pipeline**をクリックすると、プロジェクトのパイプラインセクションに表示されるはずです。

== パイプラインを実行する

* 右側の設定に進んでください。
* **Create Run** をクリックして、先ほど追加したパイプラインの新しい実行を作成します。
+
[.bordershadow]
image::05/05-create-run.jpg[create run]

* 次の設定を使用します。
** Name:
[.lines_space]
[.console-input]
[source, text]
[subs=attributes+]
Process Claim Run
** Run type:
[.lines_space]
[.console-input]
[source, text]
[subs=attributes+]
Run once immediately after creation
** claim_id:
[.lines_space]
[.console-input]
[source, text]
[subs=attributes+]
0
** detection_endpoint:
[.lines_space]
[.console-input]
[source, text]
[subs=attributes+]
http://modelmesh-serving.{user}:8008

セクション 4-5 でデプロイした画像検知モデルのエンドポイントを設定して下さい。

* 完了すると、次のようになります。
+
[.bordershadow]
image::05/05-run-settings-create-pipeline.png[run settings]

* claim_id を変更すると、処理する請求を変更することができます。未処理の請求をすべて処理するために、これを 0 に設定しました。

* **Create** をクリックして実行する様子をご覧ください
+
[.bordershadow]
image::05/05-process-claims.jpg[process]

== 結果を確認する

* パイプラインの実行が完了したら、アプリに移動して請求を確認できます
* すべての請求が処理されたことが確認できます
+
[.bordershadow]
image::05/05-process-claim3-app.jpg[claim3processed]

* 最後の請求をクリックしてください
* 長い本文ではなく、概要、場所、事故時刻、顧客感情のフィールドが表示されます
* また、損害箇所を示す四角形が付いた新しい画像もご覧いただけます
+
[.bordershadow]
image::05/05-processed-claim.jpg[claim3processed]
