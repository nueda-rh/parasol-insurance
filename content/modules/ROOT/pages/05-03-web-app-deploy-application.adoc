= Deploying the application via GitOps
include::_attributes.adoc[]

== {argocd} のインスタンスをデプロイする

まず、ArgoCD のインスタンスをあなたの名前空間にデプロイします。 +
これはアプリケーションのデプロイに使用されます。

- 次のテキストをコピーし、　{ocp-short} ターミナルに貼り付けて ArgoCD をデプロイします。
+
[.lines_space]
[.console-input]
[source, text]
cat <<EOF | oc apply -f -
---
apiVersion: argoproj.io/v1alpha1
kind: ArgoCD
metadata:
  name: argocd
spec:
  sso:
    dex:
      openShiftOAuth: true
      resources:
        limits:
          cpu: 500m
          memory: 256Mi
        requests:
          cpu: 250m
          memory: 128Mi
    provider: dex
  rbac:
    defaultPolicy: "role:readonly"
    policy: "g, system:authenticated, role:admin"
    scopes: "[groups]"
  server:
    insecure: true
    route:
      enabled: true
      tls:
        insecureEdgeTerminationPolicy: Redirect
        termination: edge
EOF

- 引き続きターミナルで、次のコマンドを実行して、 {argocd} デプロイメントのステータスを確認します。
+
[.lines_space]
[.console-input]
[source, text]
oc rollout status deploy/argocd-server

- 数秒後、デプロイメントが完了します:
+
[.bordershadow]
image::05/argocd-rollout.png[]

**オプション**: {argocd} について理解していて、そのインターフェースを確認したい場合は、次の詳細を確認してください。それ以外の場合は、次の手順に進んでください。
[%collapsible]
====
Argo がデプロイされたので、ルートを介して UI に接続できます。

- ターミナルで次のコマンドを実行して、 {argocd} インスタンスのルートを見つけましょう:
+
[.lines_space]
[.console-input]
[source, text]
echo "   {argocd} UI : https://$(oc get route argocd-server -ojsonpath='{.status.ingress[0].host}')/ "

- 次のようなものが表示されます:
+
[.bordershadow]
image::05/argocd-route.png[]

- これで、指定した認証情報 ({user}/{password}) を使用して ArgoCD UI に接続できます。
====

== GitOps 経由でアプリケーションをデプロイ

{argocd} があなたの名前空間にデプロイされたので、これを使用して GitOps 経由でアプリケーションをデプロイできます。

- 次のテキストの内容をコピーし、 {ocp-short} ターミナルに貼り付けてアプリケーションをデプロイします。
+
[.lines_space]
[.console-input]
[source, text, subs="attributes+"]
cat <<EOF | oc apply -f -
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: claim-insurance-app
spec:
  destination:
    server: https://kubernetes.default.svc
    namespace: {user}
  project: default
  source:
    path: lab-materials/05/app
    repoURL: https://github.com/rh-aiservices-bu/parasol-insurance.git
    targetRevision: main
  syncPolicy:
    automated:
      prune: true
      selfHeal: false
    syncOptions: [CreateNamespace=false]
EOF

- {ocp-short} コンソールの Admin View を開きます

[.bordershadow]
image::05/05-switch-to-admin-view.jpg[]

- アプリケーションが完全にデプロイされ、初期化されるまで待ちます。2 つのジョブ `db-init-job` と `populate-images` が完了したら、完了です (完了: 1/1)。

[.bordershadow]
image::05/jobs-completed.png[]

- アプリケーションがデプロイされたら、次のコマンドでルートを確認できます。
+
[.lines_space]
[.console-input]
[.lines_space]
[.console-input]
[source, text]
echo "   Application URL : https://$(oc get route ic-app -ojsonpath='{.status.ingress[0].host}')/ "

+
[.bordershadow]
image::05/05-open-url.jpg[]

ブラウザで URL を開いてアプリケーションにアクセスし、次のステップに進みます。
